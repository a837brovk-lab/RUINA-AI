<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruina AI: Редактор и Генератор Изображений</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Настройка шрифта Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
        }
        /* Стили для лоадера, чтобы имитировать lucide-react Loader2 */
        .lucide-loader2 {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-950 min-h-screen text-slate-100">

    <!-- Главный контейнер приложения -->
    <div id="app-container">
        <!-- Содержимое будет рендериться здесь JavaScript'ом -->
    </div>

    <script>
        // Имитация иконок lucide-react с помощью SVG
        const iconSVG = (name, size = 24, className = '') => {
            let path = '';
            // Простейшие SVG для имитации иконок
            switch(name) {
                case 'ShieldCheck': path = `<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/>`; break;
                case 'ShieldAlert': path = `<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4"/><path d="M12 16h.01"/>`; break;
                case 'Check': path = `<path d="M20 6 9 17l-5-5"/>`; break;
                case 'ImageIcon': path = `<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>`; break;
                case 'Loader2': return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-loader2 ${className}"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`;
                case 'Sparkles': path = `<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>`; break;
                case 'Download': path = `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>`; break;
                case 'Aperture': path = `<path d="m14.3 22 1.4-2.5"/><path d="m14.3 22 4.1-7.1"/><path d="m20.9 15-2.2-4"/><path d="m20.9 15-6.6-6.6"/><path d="m16.8 9.5-2.5-1.4"/><path d="m16.8 9.5-7.1-4.1"/><path d="m9.9 6.2-4-2.2"/><path d="m9.9 6.2-6.6 6.6"/><path d="m5.2 14.5 1.4 2.5"/><path d="m5.2 14.5 4.1 7.1"/><path d="m3.1 9-2.2 4"/><path d="m3.1 9 6.6 6.6"/><circle cx="12" cy="12" r="3"/>`; break;
                case 'Lock': path = `<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>`; break;
                case 'Upload': path = `<path d="M21 12v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>`; break;
                case 'X': path = `<path d="M18 6 6 18"/><path d="m6 6 12 12"/>`; break;
                default: path = '';
            }
            return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><title>${name}</title>${path}</svg>`;
        };

        // --- Глобальное Состояние (Замена React useState) ---
        const state = {
            step: 'auth', // 'auth', 'denied', 'app'
            prompt: '',
            generatedImage: null,
            isLoading: false,
            error: null,
            uploadedImageBase64: null,
            uploadedImageMimeType: null,
            debounceTimer: null,
        };

        const IMAGE_EDITING_MODEL = "gemini-2.5-flash-image-preview";
        const API_KEY = ""; // Ключ будет подставлен автоматически

        // --- Утилиты для обновления состояния и рендеринга ---
        function setState(newState) {
            Object.assign(state, newState);
            render();
        }

        // --- Debounce Logic (Замена React useEffect) ---
        function setupDebounce() {
            // Очищаем предыдущий таймер
            if (state.debounceTimer) {
                clearTimeout(state.debounceTimer);
            }

            const shouldGenerate = state.prompt.trim().length >= 1 || state.uploadedImageBase64;

            if (!shouldGenerate) {
                setState({ generatedImage: null, isLoading: false });
                return;
            }

            // Устанавливаем новый таймер
            state.debounceTimer = setTimeout(() => {
                performGeneration(state.prompt, state.uploadedImageBase64, state.uploadedImageMimeType);
            }, 1000); // Задержка 1000 мс (1 секунда)
        }

        // --- API Calls ---
        async function performGeneration(currentPrompt, base64Image, mimeType) {
            // Проверка, что есть либо текст, либо изображение
            if (!currentPrompt && !base64Image) return;

            setState({ isLoading: true, error: null, generatedImage: null });

            try {
                // 1. Формируем список частей (parts) для API
                const parts = [];
                if (currentPrompt) {
                    parts.push({ text: currentPrompt });
                } else if (!base64Image) {
                    throw new Error('Введите описание или загрузите изображение для редактирования.');
                }

                // Добавляем изображение, если оно есть
                if (base64Image && mimeType) {
                    parts.push({
                        inlineData: {
                            mimeType: mimeType,
                            data: base64Image
                        }
                    });
                }

                // 2. Создаем Payload
                const payload = {
                    contents: [{ role: "user", parts: parts }],
                    generationConfig: {
                        responseModalities: ['IMAGE']
                    },
                };

                // 3. Вызываем API
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_EDITING_MODEL}:generateContent?key=${API_KEY}`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    }
                );

                if (!response.ok) throw new Error('Не удалось сгенерировать изображение. Возможно, описание слишком сложное.');

                const data = await response.json();

                // 4. Обрабатываем ответ
                const base64Data = data?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    setState({ generatedImage: `data:image/png;base64,${base64Data}` });
                } else {
                    throw new Error('Сервер не вернул данные изображения. Попробуйте другой запрос.');
                }

            } catch (err) {
                console.error("API Error:", err);
                setState({ error: err.message || 'Произошла ошибка при генерации', generatedImage: null });
            } finally {
                setState({ isLoading: false });
            }
        }

        // --- Handlers ---

        // Обработка загрузки изображения
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                setState({ error: 'Пожалуйста, загрузите файл изображения (jpeg, png).', uploadedImageBase64: null, uploadedImageMimeType: null });
                event.target.value = ''; // Сброс поля ввода файла
                return;
            }

            setState({ error: null, uploadedImageMimeType: file.type });

            const reader = new FileReader();
            reader.onload = (e) => {
                // Base64 string включает заголовок "data:image/jpeg;base64,", нам нужно его убрать
                const base64Data = e.target.result.split(',')[1];
                setState({ uploadedImageBase64: base64Data });
                setupDebounce(); // Запустить дебаунс после загрузки
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            setState({ uploadedImageBase64: null, uploadedImageMimeType: null, generatedImage: null, error: null });
            setupDebounce(); // Сбросить дебаунс
        }

        // Ручной запуск генерации (по кнопке или Enter)
        function handleManualGeneration() {
            // Проверка: нужен хотя бы 1 символ ИЛИ загруженное изображение.
            if (state.prompt.trim().length >= 1 || state.uploadedImageBase64) {
                // Сброс таймера debounce, чтобы не сработал дважды
                if (state.debounceTimer) {
                    clearTimeout(state.debounceTimer);
                }
                performGeneration(state.prompt, state.uploadedImageBase64, state.uploadedImageMimeType);
            } else {
                setState({ error: 'Введите описание (минимум 1 символ) ИЛИ загрузите фото для редактирования.', generatedImage: null });
            }
        }

        function handleDownload() {
            if (state.generatedImage) {
                const link = document.createElement('a');
                link.href = state.generatedImage;
                link.download = `ruina-gen-${Date.now().toString().slice(-8)}.png`;
                link.click();
            }
        }

        // Обновление промпта и запуск debounce
        function handlePromptChange(event) {
            const newPrompt = event.target.value;
            setState({ prompt: newPrompt, error: null });
            setupDebounce();
        }


        // --- Render Functions (Замена JSX) ---

        function renderAuthScreen() {
            return `
                <div class="min-h-screen bg-slate-950 flex items-center justify-center p-4 font-sans text-slate-100">
                    <div class="bg-slate-900 rounded-2xl border border-slate-800 shadow-2xl max-w-md w-full p-8 text-center">
                        
                        <div class="mb-6 flex justify-center">
                            <div class="bg-blue-500/10 p-4 rounded-full border border-blue-500/20">
                                ${iconSVG('ShieldCheck', 48, 'text-blue-500')}
                            </div>
                        </div>

                        <h2 class="text-2xl font-bold text-white mb-2">
                            Проверка доступа
                        </h2>
                        <p class="text-slate-400 mb-8 text-sm">
                            Для использования сервиса Ruina AI необходимо подтвердить личность.
                        </p>

                        <div class="bg-slate-800/50 rounded-xl p-4 mb-8 border border-slate-700">
                            <p class="text-lg font-medium text-slate-200">
                                Ваша фамилия <span class="text-blue-400 font-bold">Сергеенка</span>?
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <button
                                id="deny-button"
                                class="bg-slate-800 hover:bg-slate-700 text-slate-300 font-medium py-3 px-6 rounded-xl transition-all border border-slate-700 hover:border-slate-600"
                            >
                                Да, это я
                            </button>
                            <button
                                id="allow-button"
                                class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg shadow-blue-900/20"
                            >
                                Нет
                            </button>
                        </div>
                        
                        <p class="mt-6 text-xs text-slate-600">Secure Access v1.0</p>
                    </div>
                </div>
            `;
        }

        function renderDeniedScreen() {
            return `
                <div class="min-h-screen bg-slate-950 flex items-center justify-center p-4 font-sans">
                    <div class="bg-slate-900 rounded-2xl border border-red-900/30 p-8 text-center max-w-md w-full shadow-2xl">
                        <div class="flex justify-center mb-6">
                            <div class="bg-red-500/10 p-4 rounded-full">
                                ${iconSVG('Lock', 64, 'text-red-500')}
                            </div>
                        </div>
                        <h1 class="text-2xl font-bold text-white mb-4">
                            Доступ ограничен
                        </h1>
                        <p class="text-slate-400 mb-8">
                            К сожалению, политика использования сервиса ограничивает доступ для пользователей с фамилией Сергеенка.
                        </p>
                        <button
                            id="back-to-auth-button"
                            class="text-blue-500 hover:text-blue-400 text-sm font-medium hover:underline"
                        >
                            Вернуться назад
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAppScreen() {
            const uploadedImagePreview = state.uploadedImageBase64 ? `
                <div class="mt-4 p-3 bg-slate-800 rounded-lg flex items-center justify-between border border-slate-700">
                    <div class="flex items-center gap-3">
                        <img 
                            src="data:${state.uploadedImageMimeType};base64,${state.uploadedImageBase64}" 
                            alt="Uploaded" 
                            class="w-10 h-10 object-cover rounded-md border border-slate-600"
                        />
                        <span class="text-sm text-slate-300">
                            ${state.uploadedImageMimeType.split('/')[1].toUpperCase()} файл загружен. 
                            <span class="text-blue-400 ml-2">Режим: Редактирование.</span>
                        </span>
                    </div>
                    <button id="remove-image-button" class="text-slate-500 hover:text-white transition-colors p-1 rounded-full">
                        ${iconSVG('X', 18)}
                    </button>
                </div>
            ` : '';

            const imagePlaceholder = state.isLoading ? `
                <div class="flex flex-col items-center gap-6">
                    ${iconSVG('Loader2', 48, 'text-blue-500 animate-spin')}
                    <p class="text-blue-400/80 text-sm font-medium animate-pulse">
                        Нейросеть создает изображение...
                    </p>
                </div>
            ` : `
                <div class="flex flex-col items-center gap-4 opacity-60">
                    <div class="bg-slate-800 p-6 rounded-full border border-slate-700">
                        ${iconSVG('ImageIcon', 48, 'text-slate-500')}
                    </div>
                    <p class="text-slate-500 font-medium">Здесь появится результат</p>
                </div>
            `;

            return `
                <div class="min-h-screen bg-slate-950 flex flex-col font-sans text-slate-100">
                    <!-- Header -->
                    <header class="bg-slate-900/50 backdrop-blur-md border-b border-slate-800 sticky top-0 z-20">
                        <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/20">
                                    ${iconSVG('Aperture', 24, 'text-white')}
                                </div>
                                <span class="text-xl font-bold tracking-tight text-white">
                                    Ruina <span class="text-blue-500 font-light">AI</span>
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></div>
                                <span class="text-xs font-medium text-slate-400">Online</span>
                            </div>
                        </div>
                    </header>

                    <!-- Main Content -->
                    <main class="flex-1 max-w-6xl w-full mx-auto p-4 md:p-8 flex flex-col gap-6">
                        
                        <!-- Input Area -->
                        <div class="bg-slate-900 rounded-2xl p-4 shadow-lg border border-slate-800">
                            <div class="flex flex-col md:flex-row gap-2 bg-slate-950/50 rounded-xl p-2">
                                
                                <!-- Text Input -->
                                <input
                                    id="prompt-input"
                                    type="text"
                                    value="${state.prompt}"
                                    placeholder="${state.uploadedImageBase64 ? 
                                        "Введите команду для редактирования (например: убери брови)" : 
                                        "Введите описание для генерации (минимум 1 символ)..."
                                    }"
                                    class="flex-1 bg-transparent text-white px-4 py-3 focus:outline-none placeholder:text-slate-600 font-medium"
                                />

                                <!-- Upload Button -->
                                <label for="image-upload" class="flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-white font-semibold py-3 px-4 rounded-lg transition-all cursor-pointer min-w-[120px]">
                                    ${iconSVG('Upload', 18, 'mr-2')}
                                    ${state.uploadedImageBase64 ? 'Заменить' : 'Загрузить Фото'}
                                    <input 
                                        id="image-upload"
                                        type="file" 
                                        accept="image/jpeg, image/png" 
                                        class="hidden" 
                                        onchange="handleImageUpload(event)"
                                    />
                                </label>

                                <!-- Create Button -->
                                <button
                                    id="generate-button"
                                    ${state.isLoading || (!state.prompt.trim() && !state.uploadedImageBase64) ? 'disabled' : ''}
                                    class="bg-blue-600 hover:bg-blue-500 ${state.isLoading || (!state.prompt.trim() && !state.uploadedImageBase64) ? 'disabled:bg-slate-800 disabled:text-slate-600' : ''} text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2 min-w-[160px] shadow-lg shadow-blue-900/20"
                                >
                                    ${state.isLoading ? 
                                        `${iconSVG('Loader2', 18, 'animate-spin')} Генерация...` : 
                                        `${iconSVG('Sparkles', 18)} Создать`
                                    }
                                </button>
                            </div>
                            ${state.error ? `
                                <div class="px-2 pb-2 pt-3">
                                    <div class="text-red-400 text-sm flex items-center gap-2 bg-red-950/20 border border-red-900/30 p-3 rounded-lg">
                                    ${iconSVG('ShieldAlert', 16)}
                                    ${state.error}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Uploaded Image Preview -->
                            ${uploadedImagePreview}
                        </div>

                        <!-- Result Area -->
                        <div class="flex-1 bg-slate-900 rounded-2xl border border-slate-800 min-h-[500px] flex flex-col relative overflow-hidden shadow-2xl">
                            
                            <!-- Subtle Background Pattern -->
                            <div class="absolute inset-0 opacity-30" style="background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 24px 24px;"></div>

                            <div class="flex-1 flex items-center justify-center p-8 relative z-10">
                                ${state.generatedImage ? `
                                    <div class="relative group max-w-full">
                                        <img 
                                            src="${state.generatedImage}" 
                                            alt="Generated Result" 
                                            class="max-w-full max-h-[600px] rounded-lg shadow-2xl border border-slate-700"
                                        />
                                    </div>
                                ` : imagePlaceholder}
                            </div>

                            <!-- Action Bar -->
                            ${(state.generatedImage || (state.uploadedImageBase64 && !state.isLoading)) ? `
                                <div class="border-t border-slate-800 bg-slate-900/90 p-4 flex justify-between items-center backdrop-blur-sm relative z-20 rounded-b-2xl">
                                    <div class="text-xs text-slate-500 font-mono">
                                        ${state.generatedImage ? `ID: ${Date.now().toString().slice(-8)}` : 'Ожидание генерации...'}
                                    </div>
                                    ${state.generatedImage ? `
                                        <button
                                            id="download-button"
                                            class="bg-white hover:bg-slate-200 text-slate-900 font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all shadow-lg"
                                        >
                                            ${iconSVG('Download', 18)}
                                            Скачать PNG
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </main>

                    <!-- Footer -->
                    <footer class="p-6 text-center mt-auto border-t border-slate-900">
                        <p class="text-slate-600 text-sm">
                            © 2025 Ruina AI Systems. All rights reserved.
                        </p>
                    </footer>
                </div>
            `;
        }

        // --- Главная функция рендеринга и привязки событий ---
        function render() {
            const container = document.getElementById('app-container');
            let contentHtml = '';

            // 1. Рендеринг контента в зависимости от шага
            switch (state.step) {
                case 'auth':
                    contentHtml = renderAuthScreen();
                    break;
                case 'denied':
                    contentHtml = renderDeniedScreen();
                    break;
                case 'app':
                    contentHtml = renderAppScreen();
                    break;
                default:
                    contentHtml = '<div>Ошибка: Неизвестный шаг</div>';
            }

            container.innerHTML = contentHtml;

            // 2. Перепривязка событий после рендеринга (важный шаг для чистого JS)
            if (state.step === 'auth') {
                document.getElementById('deny-button').onclick = () => setState({ step: 'denied' });
                document.getElementById('allow-button').onclick = () => setState({ step: 'app' });
            } else if (state.step === 'denied') {
                document.getElementById('back-to-auth-button').onclick = () => setState({ step: 'auth' });
            } else if (state.step === 'app') {
                // Ввод текста
                const promptInput = document.getElementById('prompt-input');
                if (promptInput) {
                    promptInput.oninput = handlePromptChange;
                    promptInput.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault(); // Предотвратить отправку формы
                            handleManualGeneration();
                        }
                    };
                }
                
                // Загрузка изображения (привязано в HTML через onchange="handleImageUpload(event)")
                
                // Кнопка генерации
                const generateButton = document.getElementById('generate-button');
                if (generateButton) {
                    generateButton.onclick = handleManualGeneration;
                }

                // Кнопка скачивания
                const downloadButton = document.getElementById('download-button');
                if (downloadButton) {
                    downloadButton.onclick = handleDownload;
                }

                // Кнопка удаления загруженного изображения
                const removeImageButton = document.getElementById('remove-image-button');
                if (removeImageButton) {
                    removeImageButton.onclick = removeImage;
                }
            }
        }

        // Запуск приложения
        window.onload = render;

    </script>
</body>
</html>
